name: Revert Commit After Sync

on:
  workflow_run:
    workflows: ["Sync FrogPilot-Staging"]
    types:
      - completed
  workflow_dispatch:

jobs:
  revert-commit:
    runs-on: ubuntu-latest
    steps:

      - name: Configure Git to skip symlinks
        run: git config --global core.symlinks false
        
      - name: Checkout repo without symlinks
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Ensure you fetch all history for commits, tags, etc
          persist-credentials: false

      - name: Setup Git Config
        run: |
          git config --global user.email "55640145+BRid37@users.noreply.github.com"
          git config --global user.name "BRid37"

      - name: Ensure clean state
        run: |
          git checkout fp-FrogPilot-Staging
          git fetch origin fp-FrogPilot-Staging
          git reset --hard origin/fp-FrogPilot-Staging
          git clean -fdx

      - name: Find commit hash by name and revert
        run: |
          git log --oneline --first-parent --grep "Compile FrogPilot" fp-FrogPilot-Staging > log.txt
          commit=$(cat log.txt | head -n 1 | cut -d " " -f 1)
          echo "Commit to revert: $commit"
          git revert $commit

      - name: Cherry-pick commit
        run: |
          git cherry-pick 6b17a0071c45eea9f0e438f3e1cc380fc2f4e4e4
          git cherry-pick c4bd59a5ae9821e577447f91144a74c1ab31ba41
          git cherry-pick d5440abc8fb254483ebf0723d9847bfff72f609b
          git cherry-pick 8113742f83b36099c1c314e55312a28407c7b6aa

      - name: Push changes
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          git push origin fp-FrogPilot-Staging

